// LIST REST call
func httpList{{initialCap .}}s(w http.ResponseWriter, r *http.Request, vars map[string]string) (interface{}, error) {
	log.Debugf("Received httpList{{initialCap .}}s: %+v", vars)

	list := make([]*{{initialCap .}}, 0)
	for _, obj := range collections.{{.}}s {
		list = append(list, obj)
	}

	// Return the list
	return list, nil
}

// GET REST call
func httpGet{{initialCap .}}(w http.ResponseWriter, r *http.Request, vars map[string]string) (interface{}, error) {
	log.Debugf("Received httpGet{{initialCap .}}: %+v", vars)

	key := vars["key"]

	obj := collections.{{.}}s[key]
	if obj == nil {
		log.Errorf("{{.}} %s not found", key)
		return nil, errors.New("{{.}} not found")
	}

	// Return the obj
	return obj, nil
}

// CREATE REST call
func httpCreate{{initialCap .}}(w http.ResponseWriter, r *http.Request, vars map[string]string) (interface{}, error) {
	log.Debugf("Received httpGet{{initialCap .}}: %+v", vars)

	var obj {{initialCap .}}
	key := vars["key"]

	// Get object from the request
	err := json.NewDecoder(r.Body).Decode(&obj)
	if err != nil {
		log.Errorf("Error decoding {{.}} create request. Err %v", err)
		return nil, err
	}

	// set the key
	obj.Key = key

	// Create the object
	err = Create{{initialCap .}}(&obj)
	if err != nil {
		log.Errorf("Create{{initialCap .}} error for: %+v. Err: %v", obj, err)
		return nil, err
	}

	// Return the obj
	return obj, nil
}

// DELETE rest call
func httpDelete{{initialCap .}}(w http.ResponseWriter, r *http.Request, vars map[string]string) (interface{}, error) {
	log.Debugf("Received httpDelete{{initialCap .}}: %+v", vars)

	key := vars["key"]

	// Delete the object
	err := Delete{{initialCap .}}(key)
	if err != nil {
		log.Errorf("Delete{{initialCap .}} error for: %s. Err: %v", key, err)
		return nil, err
	}

	// Return the obj
	return key, nil
}

// Create a {{.}} object
func Create{{initialCap .}}(obj *{{initialCap .}}) error {
	// Validate parameters
	err := Validate{{initialCap .}}(obj)
	if err != nil {
		log.Errorf("Validate{{initialCap .}} retruned error for: %+v. Err: %v", obj, err)
		return err
	}

	// Check if we handle this object
	if objCallbackHandler.{{initialCap .}}Cb == nil {
		log.Errorf("No callback registered for {{.}} object")
		return errors.New("Invalid object type")
	}

	// Check if object already exists
	if collections.{{.}}s[obj.Key] != nil {
		// Perform Update callback
		err = objCallbackHandler.{{initialCap .}}Cb.{{initialCap .}}Update(collections.{{.}}s[obj.Key], obj)
		if err != nil {
			log.Errorf("{{initialCap .}}Update retruned error for: %+v. Err: %v", obj, err)
			return err
		}
	} else {
		// save it in cache
		collections.{{.}}s[obj.Key] = obj

		// Perform Create callback
		err = objCallbackHandler.{{initialCap .}}Cb.{{initialCap .}}Create(obj)
		if err != nil {
			log.Errorf("{{initialCap .}}Create retruned error for: %+v. Err: %v", obj, err)
			delete(collections.{{.}}s, obj.Key)
			return err
		}
	}

	// Write it to modeldb
	err = obj.Write()
	if err != nil {
		log.Errorf("Error saving {{.}} %s to db. Err: %v", obj.Key, err)
		return err
	}

	return nil
}

// Return a pointer to {{.}} from collection
func Find{{initialCap .}}(key string) *{{initialCap .}} {
	obj := collections.{{.}}s[key]
	if obj == nil {
		log.Errorf("{{.}} %s not found", key)
		return nil
	}

	return obj
}

// Delete a {{.}} object
func Delete{{initialCap .}}(key string) error {
	obj := collections.{{.}}s[key]
	if obj == nil {
		log.Errorf("{{.}} %s not found", key)
		return errors.New("{{.}} not found")
	}

	// Check if we handle this object
	if objCallbackHandler.{{initialCap .}}Cb == nil {
		log.Errorf("No callback registered for {{.}} object")
		return errors.New("Invalid object type")
	}

	// Perform callback
	err := objCallbackHandler.{{initialCap .}}Cb.{{initialCap .}}Delete(obj)
	if err != nil {
		log.Errorf("{{initialCap .}}Delete retruned error for: %+v. Err: %v", obj, err)
		return err
	}

	// delete it from modeldb
	err = obj.Delete()
	if err != nil {
		log.Errorf("Error deleting {{.}} %s. Err: %v", obj.Key, err)
	}

	// delete it from cache
	delete(collections.{{.}}s, key)

	return nil
}

func (self *{{initialCap .}}) GetType() string {
	return "{{.}}"
}

func (self *{{initialCap .}}) GetKey() string {
	return self.Key
}

func (self *{{initialCap .}}) Read() error {
	if self.Key == "" {
		log.Errorf("Empty key while trying to read {{.}} object")
		return errors.New("Empty key")
	}

	return modeldb.ReadObj("{{.}}", self.Key, self)
}

func (self *{{initialCap .}}) Write() error {
	if self.Key == "" {
		log.Errorf("Empty key while trying to Write {{.}} object")
		return errors.New("Empty key")
	}

	return modeldb.WriteObj("{{.}}", self.Key, self)
}

func (self *{{initialCap .}}) Delete() error {
	if self.Key == "" {
		log.Errorf("Empty key while trying to Delete {{.}} object")
		return errors.New("Empty key")
	}

	return modeldb.DeleteObj("{{.}}", self.Key)
}

func restore{{initialCap .}}() error {
	strList, err := modeldb.ReadAllObj("{{.}}")
	if err != nil {
		log.Errorf("Error reading {{.}} list. Err: %v", err)
	}

	for _, objStr := range strList {
		// Parse the json model
		var {{.}} {{initialCap .}}
		err = json.Unmarshal([]byte(objStr), &{{.}})
		if err != nil {
			log.Errorf("Error parsing object %s, Err %v", objStr, err)
			return err
		}

		// add it to the collection
		collections.{{.}}s[{{.}}.Key] = &{{.}}
	}

	return nil
}
